<!DOCTYPE html>
<html lang="en" hidden>
  <head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>EHR Launch demo (Xealth)</title>
  </head>
  <body>
    <div id='errors'>
    </div>
    <div id="loading" class="spinner">
      <div class="bounce1"></div>
      <div class="bounce2"></div>
      <div class="bounce3"></div>
    </div>
    <div id='holder' >
    </div>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
    <script>
/// <reference path="typings/jquery/jquery.d.ts" />
/// <reference path="typings/knockout/knockout.d.ts" />
/// <reference path="typings/bootstrap/bootstrap.d.ts" />
/// <reference path="typings/knockout.mapping/knockout.mapping.d.ts" />
var Epic;
(function (Epic) {
    var AppOrchard;
    (function (AppOrchard) {
        var Test;
        (function (Test) {
            var SmartTestViewModel = (function () {
                function SmartTestViewModel(launchToken) {
                    var _this = this;
                    this.ActiveTab = ko.observable(0);
                    this.AccessToken = ko.observable(null);
                    this.PatientID = ko.observable(null);
                    this.PatientInfo = ko.observable(null);
                    this.AllergyInfo = ko.observableArray([]);
                    this.TabClicked = function (index) {
                        if (index >= 0) {
                            _this.ActiveTab(index);
                        }
                    };
                    this.RefreshState(this, launchToken);
                }
                SmartTestViewModel.prototype.RefreshState = function (me, launchToken) {
                    Epic.AppOrchard.API.ExecuteAjax(AppOrchard.HttpMethod.GET, "/Test/RefreshAccessToken", true, { launchToken: launchToken }, function (data, textStatus, jqXHR) {
                        window.clearTimeout(me.RefreshTimer);
                        me.RefreshTimer = null;
                        if (data != null) {
                            me.AccessToken(data.accessToken);
                            me.PatientID(data.patient);
                        }
                        if (me.AccessToken().length == 0) {
                            me.RefreshTimer = window.setTimeout(me.RefreshState, 200, me, launchToken);
                        }
                        else {
                            me.GetPatientInfo();
                            me.GetAllergyInfo();
                            me.GetPatientPhoto();
                        }
                    }, function (jqXHR, textStatus, errorThrown) {
                        Epic.AppOrchard.Util.LogJSEvent(false, textStatus, errorThrown, "/Test/RefreshAccessToken");
                    }, 5000, true, me);
                };
                SmartTestViewModel.prototype.GetPatientInfo = function () {
                    var _this = this;
                    Epic.AppOrchard.API.ExecuteAjax(AppOrchard.HttpMethod.GET, "/Test/PatientRead", true, { accessToken: this.AccessToken(), patient: this.PatientID() }, function (data, textStatus, jqXHR) {
                        if (data != null) {
                            _this.PatientInfo(new PatientReadKO(data));
                        }
                    }, function (jqXHR, textStatus, errorThrown) {
                        Epic.AppOrchard.Util.LogJSEvent(false, textStatus, errorThrown, "/Test/PatientRead");
                    }, 5000, true);
                };
                SmartTestViewModel.prototype.GetAllergyInfo = function () {
                    var _this = this;
                    Epic.AppOrchard.API.ExecuteAjax(AppOrchard.HttpMethod.GET, "/Test/AllergyIntolerance", true, { accessToken: this.AccessToken(), patient: this.PatientID() }, function (data, textStatus, jqXHR) {
                        if (data != null && data.length > 0) {
                            for (var k = 0; k < data.length; k++) {
                                _this.AllergyInfo.push(new AllergyKO(data[k]));
                            }
                        }
                    }, function (jqXHR, textStatus, errorThrown) {
                        Epic.AppOrchard.Util.LogJSEvent(false, textStatus, errorThrown, "/Test/AllergyIntolerance");
                    }, 5000, true);
                };
                SmartTestViewModel.prototype.GetPatientPhoto = function () {
                    var _this = this;
                    Epic.AppOrchard.API.ExecuteAjax(AppOrchard.HttpMethod.GET, "/Test/PatientPhoto", true, { accessToken: this.AccessToken(), patient: this.PatientID() }, function (data, textStatus, jqXHR) {
                        if (data != null) {
                            _this.PatientInfo().photo(data);
                        }
                    }, function (jqXHR, textStatus, errorThrown) {
                        Epic.AppOrchard.Util.LogJSEvent(false, textStatus, errorThrown, "/Test/PatientPhoto");
                    }, 5000, true);
                };
                return SmartTestViewModel;
            }());
            Test.SmartTestViewModel = SmartTestViewModel;
            var SmartAppModel = (function () {
                function SmartAppModel() {
                }
                return SmartAppModel;
            }());
            Test.SmartAppModel = SmartAppModel;
            var PatientReadKO = (function () {
                function PatientReadKO(patient) {
                    this.fhirId = ko.observable("");
                    this.firstName = ko.observable("");
                    this.lastName = ko.observable("");
                    this.sex = ko.observable("");
                    this.dob = ko.observable("");
                    this.addresses = ko.observableArray([]);
                    this.phoneNumbers = ko.observableArray([]);
                    this.emailAddresses = ko.observableArray([]);
                    this.photo = ko.observable("");
                    this.fhirId(patient.fhirId);
                    this.firstName(patient.firstName);
                    this.lastName(patient.lastName);
                    this.sex(patient.sex);
                    this.dob(patient.dob);
                    if (patient.emailAddresses != null) {
                        for (var k = 0; k < patient.emailAddresses.length; k++) {
                            this.emailAddresses.push(patient.emailAddresses[k]);
                        }
                    }
                    if (patient.phoneNumbers != null) {
                        for (var k = 0; k < patient.phoneNumbers.length; k++) {
                            this.phoneNumbers.push(patient.phoneNumbers[k]);
                        }
                    }
                    if (patient.addresses != null) {
                        for (var k = 0; k < patient.addresses.length; k++) {
                            this.addresses.push(patient.addresses[k]);
                        }
                    }
                }
                return PatientReadKO;
            }());
            Test.PatientReadKO = PatientReadKO;
            var PatientRead = (function () {
                function PatientRead() {
                }
                return PatientRead;
            }());
            Test.PatientRead = PatientRead;
            var address = (function () {
                function address() {
                }
                return address;
            }());
            Test.address = address;
            var phoneNumber = (function () {
                function phoneNumber() {
                }
                return phoneNumber;
            }());
            Test.phoneNumber = phoneNumber;
            var AllergyKO = (function () {
                function AllergyKO(allergy) {
                    this.substance = ko.observable("");
                    this.severity = ko.observable("");
                    this.reactions = ko.observableArray([]);
                    this.substance(allergy.substance);
                    this.severity(allergy.severity);
                    if (allergy.reactions != null) {
                        for (var k = 0; k < allergy.reactions.length; k++) {
                            this.reactions.push(allergy.reactions[k]);
                        }
                    }
                }
                return AllergyKO;
            }());
            Test.AllergyKO = AllergyKO;
            var allergy = (function () {
                function allergy() {
                }
                return allergy;
            }());
            Test.allergy = allergy;
        })(Test = AppOrchard.Test || (AppOrchard.Test = {}));
    })(AppOrchard = Epic.AppOrchard || (Epic.AppOrchard = {}));
})(Epic || (Epic = {}));
//# sourceMappingURL=SmartTestViewModel.js.map
      </script>
    </body>
</html>